generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Prompt {
  id        Int      @id @default(autoincrement())
  title     String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Model {
  id                 Int      @id @default(autoincrement())
  openrouterId       String   @unique @map("openrouter_id")
  name               String
  description        String?  @db.Text
  iconUrl            String?  @map("icon_url") @db.LongText // Base64 support
  contextLength      Int?     @map("context_length")
  pricingPrompt      Decimal? @map("pricing_prompt") @db.Decimal(18, 8)
  pricingCompletion  Decimal? @map("pricing_completion") @db.Decimal(18, 8)
  publicPricingPrompt     Decimal? @map("public_pricing_prompt") @db.Decimal(18, 8)
  publicPricingCompletion Decimal? @map("public_pricing_completion") @db.Decimal(18, 8)
  architecture       Json?    @map("architecture")
  tags               Json?
  displayPriority    Int      @default(0) @map("display_priority")
  isActive           Boolean  @default(true) @map("is_active")
  lastSeenAt         DateTime @default(now()) @map("last_seen_at")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  usersDefaultModel  User[]
  ratings            ModelRating[]
  reputationCache    ModelReputationCache?
}

model User {
  id               Int       @id @default(autoincrement())
  walletAddress    String?   @unique @map("wallet_address")
  guestId          String?   @unique @map("guest_id")
  displayName      String?
  nonce            String?
  isGuest          Boolean   @default(true) @map("is_guest")
  sessionToken     String?   @map("session_token")
  sessionExpiresAt DateTime? @map("session_expires_at")
  defaultModelId   Int?      @map("default_model_id")
  defaultModel     Model?    @relation(fields: [defaultModelId], references: [id])

  // Freemium / Stats
  messageCount     Int       @default(0) @map("message_count")
  isPremium        Boolean   @default(false) @map("is_premium")

  conversations    Conversation[]
  modelRatings     ModelRating[]

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Conversation {
  id        String    @id @default(uuid())
  title     String?
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  messages  Message[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // "user" | "assistant"
  content        String       @db.Text
  modelUsed      String?      // To track which model generated this

  attachmentUrl  String?      @map("attachment_url")
  attachmentType String?      @map("attachment_type") // "image", "file", etc.

  metadata       Json?        // Stores { reasoning, sources, usage, etc. }

  createdAt      DateTime     @default(now())

  @@index([conversationId])
}

model VaultDeposit {
  id            Int      @id @default(autoincrement())
  walletAddress String   @map("wallet_address")
  amountAVAX    String   @map("amount_avax") // in wei (string to preserve precision)
  amountUSD     Decimal  @map("amount_usd") @db.Decimal(18, 2) // Calculated USD value at deposit time
  txHash        String   @unique @map("tx_hash")
  depositId     Int      @map("deposit_id") // From smart contract event
  blockNumber   Int      @map("block_number")

  createdAt     DateTime @default(now())

  @@index([walletAddress])
  @@index([createdAt])
  @@map("vault_deposits")
}

model Usage {
  id            Int      @id @default(autoincrement())
  walletAddress String   @map("wallet_address")
  model         String
  inputTokens   Int      @map("input_tokens")
  outputTokens  Int      @map("output_tokens")
  costUSD       Decimal  @map("cost_usd") @db.Decimal(18, 8)
  requestId     String   @unique @map("request_id")

  createdAt     DateTime @default(now())

  @@index([walletAddress])
  @@index([createdAt])
  @@map("usage_records")
}

model X402Payment {
  id            Int      @id @default(autoincrement())
  txHash        String?  @unique @map("tx_hash")
  fromAddress   String   @map("from_address")
  toAddress     String   @map("to_address")
  amountUSDC    String   @map("amount_usdc")
  priceUSD      String   @map("price_usd")
  endpoint      String
  model         String?
  status        String   @default("pending") // pending, success, failed
  errorMessage  String?  @map("error_message") @db.Text

  createdAt     DateTime @default(now())

  @@index([fromAddress])
  @@index([endpoint])
  @@index([status])
  @@index([createdAt])
  @@map("x402_payments")
}

// ═══════════════════════════════════════════════════════════════════════════
// ERC-8004 Model Reputation System
// ═══════════════════════════════════════════════════════════════════════════

model ModelRating {
  id            Int      @id @default(autoincrement())
  modelId       Int      @map("model_id")
  model         Model    @relation(fields: [modelId], references: [id])
  userId        Int      @map("user_id")
  user          User     @relation(fields: [userId], references: [id])

  // Rating data (ERC-8004 compliant)
  score         Int      // 1-5 stars
  tag1          String?  // Primary tag: "quality", "speed", "accuracy", "value"
  tag2          String?  // Secondary tag (optional)
  comment       String?  @db.Text // Optional review comment

  // Blockchain sync status
  txHash        String?  @unique @map("tx_hash") // When synced to chain
  syncedAt      DateTime? @map("synced_at")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([modelId, userId]) // One rating per user per model
  @@index([modelId])
  @@index([userId])
  @@index([score])
  @@index([tag1])
  @@map("model_ratings")
}

model ModelReputationCache {
  id                Int      @id @default(autoincrement())
  modelId           Int      @unique @map("model_id")
  model             Model    @relation(fields: [modelId], references: [id])

  // Aggregate stats (cached for performance)
  totalRatings      Int      @default(0) @map("total_ratings")
  sumScores         Int      @default(0) @map("sum_scores")
  averageScore      Decimal  @default(0) @map("average_score") @db.Decimal(3, 2) // e.g., 4.50
  fiveStarCount     Int      @default(0) @map("five_star_count")
  fourStarCount     Int      @default(0) @map("four_star_count")
  threeStarCount    Int      @default(0) @map("three_star_count")
  twoStarCount      Int      @default(0) @map("two_star_count")
  oneStarCount      Int      @default(0) @map("one_star_count")

  // Last blockchain sync
  lastSyncedBlock   Int?     @map("last_synced_block")
  lastSyncedAt      DateTime? @map("last_synced_at")

  updatedAt         DateTime @updatedAt

  @@map("model_reputation_cache")
}

// ═══════════════════════════════════════════════════════════════════════════
// Decentralized Ollama Subnet
// ═══════════════════════════════════════════════════════════════════════════

model OllamaRequestLog {
  id               Int      @id @default(autoincrement())
  operatorTokenId  Int      @default(0) @map("operator_token_id")
  operatorAddress  String?  @map("operator_address")
  model            String
  inputTokens      Int      @default(0) @map("input_tokens")
  outputTokens     Int      @default(0) @map("output_tokens")
  latencyMs        Int      @default(0) @map("latency_ms")
  success          Boolean  @default(true)
  synced           Boolean  @default(false)
  createdAt        DateTime @default(now())

  @@index([operatorTokenId])
  @@index([operatorAddress])
  @@index([synced])
  @@index([createdAt])
  @@map("ollama_request_logs")
}

model OperatorCache {
  id               Int      @id @default(autoincrement())
  tokenId          Int      @default(0) @map("token_id")
  operatorAddress  String?  @unique @map("operator_address")
  endpoint         String
  supportedModels  Json     @map("supported_models")
  stakeAmount      String   @map("stake_amount")
  performanceScore Int      @default(50) @map("performance_score")
  isActive         Boolean  @default(true) @map("is_active")
  lastSyncedAt     DateTime @default(now()) @map("last_synced_at")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isActive])
  @@map("operator_cache")
}
